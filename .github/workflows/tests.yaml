name: Tests

on:
  push:
    branches:
      - 'main'
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - 'crates/**'
      - 'indexify/**'
      - 'tensorlake'
      - '.github/workflows/tests.yaml'

env:
  CARGO_TERM_COLOR: always
  TENSORLAKE_API_URL: http://localhost:8900

jobs:
  lint_server:
    name: Lint Indexify Server
    runs-on: ubuntu-latest
    steps:
      - name: Install protobuf package
        run: sudo apt update && sudo apt install -y protobuf-compiler
      - uses: actions/checkout@v6
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy, rustfmt
          cache-directories: |
            target
      - name: Install Just
        uses: extractions/setup-just@v3
      - name: Check formatting of indexify-server
        run: just check-rust
      - name: Check linting of indexify-server
        run: just lint-rust

  build_server:
    name: Build Indexify Server
    runs-on: namespace-profile-indexify-builder
    steps:
      - name: Install protobuf package
        run: sudo apt update && sudo apt install -y protobuf-compiler
      - uses: actions/checkout@v6
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-directories: |
            target
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - name: Install Just
        uses: extractions/setup-just@v3
      - name: Build indexify-server
        run: just build-rust
      - name: Test indexify-server
        run: just test-rust
      - name: Upload indexify-server
        uses: actions/upload-artifact@v6
        with:
          name: indexify-server
          path: target/debug/indexify-server
      - name: Upload indexify-dataplane
        uses: actions/upload-artifact@v6
        with:
          name: indexify-dataplane
          path: target/debug/indexify-dataplane

  lint_python_packages:
    name: Lint Python packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
      - name: Install poetry
        run: pipx install --force 'poetry==2.0.0'
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'poetry'
      - name: Build and lint indexify
        run: cd indexify && make build && make check

  # acceptance_tests and map_reduce_benchmark commented out temporarily
  # to isolate dataplane CI issues.

  acceptance_tests_dataplane:
    name: Run Acceptance Tests (Dataplane)
    needs: [build_server]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
      - name: Download indexify-server
        uses: actions/download-artifact@v7
        with:
          name: indexify-server
      - name: Download indexify-dataplane
        uses: actions/download-artifact@v7
        with:
          name: indexify-dataplane
      - name: Start Background Indexify Server
        uses: JarvusInnovations/background-action@v1
        with:
          run: |
            chmod u+x ./indexify-server
            RUST_LOG=info ./indexify-server &
            echo $! > /tmp/indexify-server.pid &
          wait-on: |
            tcp:localhost:8900
          tail: true
          wait-for: 30s
          log-output: true
          log-output-if: true
      - name: Install poetry
        run: pipx install --force 'poetry==2.0.0'
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'poetry'
      - name: Build tensorlake
        run: cd tensorlake && make build
      - name: Run Indexify Dataplane tests
        run: |
          chmod u+x ./indexify-dataplane
          export DATAPLANE_BIN=$(pwd)/indexify-dataplane
          export PATH=$(cd tensorlake && poetry env info --path)/bin:$PATH
          cd indexify/tests
          bash run_tests_dataplane.sh
      - name: Terminate processes
        if: always()
        run: |
          pkill -SIGTERM -F /tmp/indexify-server.pid || true
          pkill -f indexify-dataplane || true
          pkill -f function-executor || true
      - name: Wait for processes termination
        if: always()
        run: |
          for i in $(seq 1 10); do
            if ! pgrep -f 'indexify-server|indexify-dataplane|function-executor' >/dev/null 2>&1; then
              break
            fi
            echo "Waiting for processes to exit..."
            sleep 1
          done
      - name: Validate that all processes terminated
        if: always()
        run: |
          if pgrep -f indexify; then
            echo "Error: Some Indexify processes are still running."
            ps aux | grep indexify
            exit 1
          fi

  # map_reduce_benchmark_dataplane commented out temporarily
  # to isolate dataplane CI issues.
